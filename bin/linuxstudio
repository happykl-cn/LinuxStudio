#!/bin/bash
#==============================================================================
# LinuxStudio CLI - Command Line Interface
# Version: 1.0.0
# Description: LinuxStudio Framework Management Tool
# Author: Dino Studio
#==============================================================================

set -e

# Global variables
LINUXSTUDIO_ROOT="/opt/linuxstudio"
LINUXSTUDIO_VERSION="1.0.0"
CONFIG_PATH="$LINUXSTUDIO_ROOT/config"
DATA_PATH="$LINUXSTUDIO_ROOT/data"
PLUGINS_PATH="$LINUXSTUDIO_ROOT/plugins"
COMPONENTS_PATH="$LINUXSTUDIO_ROOT/components"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Print colored messages
success() { echo -e "${GREEN}✅ $@${NC}"; }
error() { echo -e "${RED}❌ $@${NC}"; }
warning() { echo -e "${YELLOW}⚠️  $@${NC}"; }
info() { echo -e "${CYAN}ℹ️  $@${NC}"; }

#==============================================================================
# Helper Functions
#==============================================================================

# Check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        error "This command requires root privileges. Please run with sudo."
        exit 1
    fi
}

# Initialize LinuxStudio directories
init_directories() {
    mkdir -p "$LINUXSTUDIO_ROOT"/{bin,lib,config,data,plugins,components,logs,scripts,web}
    mkdir -p "$PLUGINS_PATH"
    mkdir -p "$COMPONENTS_PATH"
}

# Load plugin metadata
load_plugin_metadata() {
    local plugin_name=$1
    local metadata_file="$PLUGINS_PATH/$plugin_name/metadata.json"
    
    if [ -f "$metadata_file" ]; then
        cat "$metadata_file"
    else
        echo "{}"
    fi
}

# Save plugin metadata
save_plugin_metadata() {
    local plugin_name=$1
    local status=$2
    local metadata_file="$PLUGINS_PATH/$plugin_name/metadata.json"
    
    mkdir -p "$(dirname "$metadata_file")"
    cat > "$metadata_file" <<EOF
{
  "name": "$plugin_name",
  "version": "1.0.0",
  "status": "$status",
  "installed_at": "$(date -Iseconds)",
  "enabled": $([ "$status" = "enabled" ] && echo "true" || echo "false")
}
EOF
}

#==============================================================================
# Framework Commands
#==============================================================================

cmd_status() {
    echo ""
    info "LinuxStudio Framework Status"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Version:        $LINUXSTUDIO_VERSION"
    echo "Install Path:   $LINUXSTUDIO_ROOT"
    echo "Config Path:    $CONFIG_PATH"
    echo "Data Path:      $DATA_PATH"
    echo ""
    
    # Count components and plugins
    local component_count=$(find "$COMPONENTS_PATH" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
    local plugin_count=$(find "$PLUGINS_PATH" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
    
    echo "Installed Components: $component_count"
    echo "Installed Plugins:    $plugin_count"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

cmd_update() {
    check_root
    info "Updating LinuxStudio Framework..."
    
    # Update framework
    if [ -f "$LINUXSTUDIO_ROOT/scripts/update.sh" ]; then
        bash "$LINUXSTUDIO_ROOT/scripts/update.sh"
    else
        warning "Update script not found. Please reinstall LinuxStudio."
    fi
}

#==============================================================================
# Component Management
#==============================================================================

cmd_component_list() {
    echo ""
    info "Available Components"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    # List installed components
    if [ -d "$COMPONENTS_PATH" ]; then
        for comp_dir in "$COMPONENTS_PATH"/*; do
            if [ -d "$comp_dir" ]; then
                local comp_name=$(basename "$comp_dir")
                local status="✅ Installed"
                echo "  $comp_name - $status"
            fi
        done
    else
        warning "No components installed yet."
    fi
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

cmd_component_search() {
    local keyword=$1
    if [ -z "$keyword" ]; then
        error "Please provide a search keyword"
        exit 1
    fi
    
    echo ""
    info "Searching for components matching '$keyword'..."
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    # Search in component repository (placeholder)
    warning "Component search requires network connection to repository."
    info "Available components matching '$keyword':"
    echo "  • nginx - High-performance web server"
    echo "  • docker - Container runtime"
    echo "  • mysql - Relational database"
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

cmd_component_install() {
    check_root
    local component=$1
    
    if [ -z "$component" ]; then
        error "Please specify a component to install"
        exit 1
    fi
    
    info "Installing component: $component"
    
    # Install component using system package manager
    if command -v apt-get &>/dev/null; then
        apt-get update -qq
        apt-get install -y "$component"
    elif command -v yum &>/dev/null; then
        yum install -y "$component"
    elif command -v dnf &>/dev/null; then
        dnf install -y "$component"
    elif command -v pacman &>/dev/null; then
        pacman -S --noconfirm "$component"
    else
        error "Unsupported package manager"
        exit 1
    fi
    
    # Mark as installed
    mkdir -p "$COMPONENTS_PATH/$component"
    echo "$(date -Iseconds)" > "$COMPONENTS_PATH/$component/installed_at"
    
    success "Component '$component' installed successfully"
}

cmd_component_uninstall() {
    check_root
    local component=$1
    
    if [ -z "$component" ]; then
        error "Please specify a component to uninstall"
        exit 1
    fi
    
    warning "Uninstalling component: $component"
    
    # Uninstall component
    if command -v apt-get &>/dev/null; then
        apt-get remove -y "$component"
    elif command -v yum &>/dev/null; then
        yum remove -y "$component"
    elif command -v dnf &>/dev/null; then
        dnf remove -y "$component"
    elif command -v pacman &>/dev/null; then
        pacman -R --noconfirm "$component"
    fi
    
    # Remove from tracking
    rm -rf "$COMPONENTS_PATH/$component"
    
    success "Component '$component' uninstalled successfully"
}

#==============================================================================
# Plugin Management
#==============================================================================

cmd_plugin_list() {
    echo ""
    info "Installed Plugins"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    if [ ! -d "$PLUGINS_PATH" ] || [ -z "$(ls -A "$PLUGINS_PATH" 2>/dev/null)" ]; then
        warning "No plugins installed yet."
        echo ""
        info "Available plugins:"
        echo "  • ros2           - Robot Operating System 2"
        echo "  • robot-arm      - Robot arm control libraries"
        echo "  • opencv         - Computer vision library"
        echo "  • pytorch        - Deep learning framework"
        echo "  • tensorflow     - Machine learning framework"
        echo "  • cuda-toolkit   - NVIDIA CUDA development kit"
        echo ""
        info "Install a plugin: sudo linuxstudio plugin install <name>"
    else
        for plugin_dir in "$PLUGINS_PATH"/*; do
            if [ -d "$plugin_dir" ]; then
                local plugin_name=$(basename "$plugin_dir")
                local metadata=$(load_plugin_metadata "$plugin_name")
                local status=$(echo "$metadata" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                local enabled=$(echo "$metadata" | grep -o '"enabled":[^,}]*' | cut -d':' -f2)
                
                if [ "$enabled" = "true" ]; then
                    echo "  ✅ $plugin_name (enabled)"
                else
                    echo "  ⚪ $plugin_name (disabled)"
                fi
            fi
        done
    fi
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

cmd_plugin_install() {
    check_root
    local plugin=$1
    
    if [ -z "$plugin" ]; then
        error "Please specify a plugin to install"
        exit 1
    fi
    
    info "Installing plugin: $plugin"
    
    # Create plugin directory
    local plugin_dir="$PLUGINS_PATH/$plugin"
    mkdir -p "$plugin_dir"
    
    # Install based on plugin type
    case "$plugin" in
        ros2)
            info "Installing ROS2 Humble..."
            # Add ROS2 repository
            apt-get update -qq
            apt-get install -y software-properties-common curl
            curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg 2>/dev/null || true
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null
            apt-get update -qq
            apt-get install -y ros-humble-desktop python3-colcon-common-extensions || {
                warning "ROS2 installation requires additional configuration"
                info "See: https://docs.ros.org/en/humble/Installation.html"
            }
            ;;
        robot-arm)
            info "Installing robot arm control libraries..."
            apt-get install -y libmodbus-dev can-utils liburdfdom-dev
            pip3 install roboticstoolbox-python || true
            ;;
        opencv)
            info "Installing OpenCV..."
            apt-get install -y libopencv-dev python3-opencv
            ;;
        pytorch)
            info "Installing PyTorch..."
            pip3 install torch torchvision torchaudio
            ;;
        tensorflow)
            info "Installing TensorFlow..."
            pip3 install tensorflow
            ;;
        cuda-toolkit)
            info "Installing CUDA Toolkit..."
            if lspci | grep -i nvidia >/dev/null; then
                warning "Please install CUDA from NVIDIA website:"
                info "https://developer.nvidia.com/cuda-downloads"
            else
                error "No NVIDIA GPU detected"
                exit 1
            fi
            ;;
        *)
            warning "Unknown plugin: $plugin"
            info "Creating custom plugin directory at $plugin_dir"
            ;;
    esac
    
    # Save metadata
    save_plugin_metadata "$plugin" "enabled"
    
    success "Plugin '$plugin' installed successfully"
    info "Enable/disable: linuxstudio plugin enable/disable $plugin"
}

cmd_plugin_uninstall() {
    check_root
    local plugin=$1
    
    if [ -z "$plugin" ]; then
        error "Please specify a plugin to uninstall"
        exit 1
    fi
    
    if [ ! -d "$PLUGINS_PATH/$plugin" ]; then
        error "Plugin '$plugin' is not installed"
        exit 1
    fi
    
    warning "Uninstalling plugin: $plugin"
    
    # Remove plugin directory
    rm -rf "$PLUGINS_PATH/$plugin"
    
    success "Plugin '$plugin' uninstalled successfully"
}

cmd_plugin_enable() {
    check_root
    local plugin=$1
    
    if [ -z "$plugin" ]; then
        error "Please specify a plugin to enable"
        exit 1
    fi
    
    if [ ! -d "$PLUGINS_PATH/$plugin" ]; then
        error "Plugin '$plugin' is not installed"
        exit 1
    fi
    
    save_plugin_metadata "$plugin" "enabled"
    success "Plugin '$plugin' enabled"
}

cmd_plugin_disable() {
    check_root
    local plugin=$1
    
    if [ -z "$plugin" ]; then
        error "Please specify a plugin to disable"
        exit 1
    fi
    
    if [ ! -d "$PLUGINS_PATH/$plugin" ]; then
        error "Plugin '$plugin' is not installed"
        exit 1
    fi
    
    save_plugin_metadata "$plugin" "disabled"
    warning "Plugin '$plugin' disabled"
}

#==============================================================================
# Scene Management
#==============================================================================

cmd_scene_list() {
    echo ""
    info "Available Development Scenes"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  1. web-development       - Web Development (PHP/Java/Node.js)"
    echo "  2. embedded              - Embedded Systems (ARM/RISC-V)"
    echo "  3. robotics              - Robotics & Automation (ROS2)"
    echo "  4. ai-ml                 - AI/ML Development"
    echo "  5. game-dev              - Game Development"
    echo "  6. devops                - Cloud Native / DevOps"
    echo "  7. security              - Cybersecurity / Penetration Testing"
    echo "  8. blockchain            - Blockchain Development"
    echo "  9. iot                   - IoT Development"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    info "Apply a scene: sudo linuxstudio scene apply <name>"
}

cmd_scene_apply() {
    check_root
    local scene=$1
    
    if [ -z "$scene" ]; then
        error "Please specify a scene to apply"
        echo ""
        cmd_scene_list
        exit 1
    fi
    
    info "Applying scene: $scene"
    warning "This will install multiple components. Continue? [y/N]"
    read -r confirm
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        info "Cancelled"
        exit 0
    fi
    
    case "$scene" in
        web-development|web)
            info "Installing Web Development components..."
            cmd_component_install nginx
            cmd_component_install php
            cmd_component_install mysql-server
            cmd_component_install redis-server
            ;;
        embedded)
            info "Installing Embedded Development components..."
            cmd_component_install gcc-arm-none-eabi
            cmd_component_install openocd
            cmd_component_install minicom
            ;;
        robotics)
            info "Installing Robotics & Automation components..."
            cmd_plugin_install ros2
            cmd_plugin_install robot-arm
            cmd_plugin_install opencv
            ;;
        ai-ml)
            info "Installing AI/ML Development components..."
            cmd_component_install python3-pip
            cmd_plugin_install pytorch
            cmd_plugin_install tensorflow
            ;;
        devops)
            info "Installing DevOps components..."
            info "Installing Docker..."
            curl -fsSL https://get.docker.com | sh
            cmd_component_install docker-compose
            ;;
        *)
            error "Unknown scene: $scene"
            cmd_scene_list
            exit 1
            ;;
    esac
    
    success "Scene '$scene' applied successfully"
}

#==============================================================================
# Remote Server Management
#==============================================================================

cmd_remote_list() {
    echo ""
    info "Remote Servers"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    local remote_config="$CONFIG_PATH/remote_servers.conf"
    if [ -f "$remote_config" ]; then
        cat "$remote_config"
    else
        warning "No remote servers configured"
        info "Add a server: linuxstudio remote add user@host"
    fi
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

cmd_remote_add() {
    local host=$1
    
    if [ -z "$host" ]; then
        error "Please specify a remote host (user@hostname)"
        exit 1
    fi
    
    # Test connection
    info "Testing connection to $host..."
    if ssh -o ConnectTimeout=5 "$host" "echo Connection successful" &>/dev/null; then
        success "Connection successful"
        
        # Add to config
        local remote_config="$CONFIG_PATH/remote_servers.conf"
        mkdir -p "$CONFIG_PATH"
        echo "$host" >> "$remote_config"
        
        success "Remote server '$host' added"
    else
        error "Cannot connect to $host"
        info "Please check SSH configuration and credentials"
        exit 1
    fi
}

#==============================================================================
# Help & Version
#==============================================================================

show_help() {
    cat <<EOF
LinuxStudio CLI v${LINUXSTUDIO_VERSION}
High-Performance Linux Environment Manager

Usage: xkl <command> [options]
   or: linuxstudio <command> [options]  (legacy)

Framework Commands:
  status              Show framework status
  update              Update LinuxStudio framework

Component Management:
  component list                    List installed components
  component search <keyword>        Search for components
  component install <name>          Install a component
  component uninstall <name>        Uninstall a component
  component update <name>           Update a component

Plugin Management:
  plugin list                       List installed plugins
  plugin install <name>             Install a plugin
  plugin uninstall <name>           Uninstall a plugin
  plugin enable <name>              Enable a plugin
  plugin disable <name>             Disable a plugin

Scene Management:
  scene list                        List available scenes
  scene apply <name>                Apply a development scene
  scene create <name>               Create custom scene

Remote Server Management:
  remote list                       List remote servers
  remote add <user@host>            Add remote server
  remote deploy <host> <scene>      Deploy to remote server

Other Commands:
  help                Show this help message
  version             Show version information

Examples:
  xkl status
  xkl plugin install ros2
  xkl scene apply robotics
  xkl remote add user@192.168.1.100

For more information, visit: https://docs.linuxstudio.org
EOF
}

show_version() {
    echo "LinuxStudio Framework v${LINUXSTUDIO_VERSION}"
    echo "Copyright (c) 2025 Dino Studio"
}

#==============================================================================
# Main Command Router
#==============================================================================

main() {
    # Initialize directories if needed
    if [ ! -d "$LINUXSTUDIO_ROOT" ]; then
        warning "LinuxStudio not initialized. Run installation script first."
        info "curl -fsSL https://linuxstudio.org/heaven.sh | sudo bash"
        exit 1
    fi
    
    local command=$1
    shift || true
    
    case "$command" in
        # Framework commands
        status)         cmd_status "$@" ;;
        update)         cmd_update "$@" ;;
        
        # Component commands
        component)
            local subcommand=$1
            shift || true
            case "$subcommand" in
                list)       cmd_component_list "$@" ;;
                search)     cmd_component_search "$@" ;;
                install)    cmd_component_install "$@" ;;
                uninstall)  cmd_component_uninstall "$@" ;;
                *)          error "Unknown component command: $subcommand"; show_help; exit 1 ;;
            esac
            ;;
        
        # Plugin commands
        plugin)
            local subcommand=$1
            shift || true
            case "$subcommand" in
                list)       cmd_plugin_list "$@" ;;
                install)    cmd_plugin_install "$@" ;;
                uninstall)  cmd_plugin_uninstall "$@" ;;
                enable)     cmd_plugin_enable "$@" ;;
                disable)    cmd_plugin_disable "$@" ;;
                *)          error "Unknown plugin command: $subcommand"; show_help; exit 1 ;;
            esac
            ;;
        
        # Scene commands
        scene)
            local subcommand=$1
            shift || true
            case "$subcommand" in
                list)       cmd_scene_list "$@" ;;
                apply)      cmd_scene_apply "$@" ;;
                *)          error "Unknown scene command: $subcommand"; show_help; exit 1 ;;
            esac
            ;;
        
        # Remote commands
        remote)
            local subcommand=$1
            shift || true
            case "$subcommand" in
                list)       cmd_remote_list "$@" ;;
                add)        cmd_remote_add "$@" ;;
                *)          error "Unknown remote command: $subcommand"; show_help; exit 1 ;;
            esac
            ;;
        
        # Help & Version
        help|--help|-h) show_help ;;
        version|--version|-v) show_version ;;
        
        # Unknown command
        "")
            error "No command specified"
            show_help
            exit 1
            ;;
        *)
            error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"

