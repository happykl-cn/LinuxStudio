cmake_minimum_required(VERSION 3.10)

project(LinuxStudio 
    VERSION 1.0.0
    DESCRIPTION "High-Performance Linux Environment Manager"
    LANGUAGES CXX
)

# ========== å¹³å°æ£€æµ‹ ==========
if(UNIX AND NOT APPLE)
    message(STATUS "âœ… Platform: Linux (Recommended)")
    set(PLATFORM_LINUX TRUE)
elseif(WIN32)
    message(WARNING "âš ï¸  Platform: Windows (Limited Support)")
    message(WARNING "   LinuxStudio is designed for Linux.")
    message(WARNING "   Some features may not work correctly on Windows.")
    message(WARNING "   Consider using WSL2 for full functionality.")
    set(PLATFORM_WINDOWS TRUE)
elseif(APPLE)
    message(WARNING "âš ï¸  Platform: macOS (Experimental)")
    message(WARNING "   LinuxStudio is designed for Linux.")
    set(PLATFORM_MACOS TRUE)
else()
    message(FATAL_ERROR "âŒ Unsupported platform")
endif()

# ========== æ¶æ„æ£€æµ‹ ==========
if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64" OR CMAKE_SYSTEM_PROCESSOR MATCHES "^aarch64" OR CMAKE_SYSTEM_PROCESSOR MATCHES "^arm64")
    message(STATUS "ğŸ—ï¸  Architecture: ARM64 (aarch64)")
    set(TARGET_ARCH_ARM64 TRUE)
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "armv7" OR CMAKE_SYSTEM_PROCESSOR MATCHES "armhf" OR CMAKE_SYSTEM_PROCESSOR MATCHES "armv7l")
    message(STATUS "ğŸ—ï¸  Architecture: ARM32 (armv7/armhf)")
    set(TARGET_ARCH_ARM32 TRUE)
    set(TARGET_ARCH_ARM32_V7 TRUE)
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "armv6" OR CMAKE_SYSTEM_PROCESSOR MATCHES "armv6l")
    message(STATUS "ğŸ—ï¸  Architecture: ARM32 (armv6)")
    set(TARGET_ARCH_ARM32 TRUE)
    set(TARGET_ARCH_ARM32_V6 TRUE)
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "arm" OR CMAKE_SYSTEM_PROCESSOR MATCHES "^arm")
    message(STATUS "ğŸ—ï¸  Architecture: ARM32 (generic)")
    set(TARGET_ARCH_ARM32 TRUE)
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|AMD64")
    message(STATUS "ğŸ—ï¸  Architecture: x86_64 (amd64)")
    set(TARGET_ARCH_X86_64 TRUE)
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "i[3-6]86" OR CMAKE_SYSTEM_PROCESSOR MATCHES "^i386")
    message(STATUS "ğŸ—ï¸  Architecture: x86 (32-bit)")
    set(TARGET_ARCH_X86 TRUE)
else()
    message(STATUS "ğŸ—ï¸  Architecture: ${CMAKE_SYSTEM_PROCESSOR} (detected)")
endif()

# C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ç¼–è¯‘é€‰é¡¹
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -g -O0")
    
    # ARM32 ç‰¹å®šä¼˜åŒ–
    if(TARGET_ARCH_ARM32)
        message(STATUS "ğŸ”§ Applying ARM32 optimizations...")
        if(TARGET_ARCH_ARM32_V7)
            # ARMv7 (Raspberry Pi 2/3, å¤§å¤šæ•°ç°ä»£ ARM32 è®¾å¤‡)
            set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard")
            message(STATUS "   - ARMv7 with NEON SIMD support")
        elseif(TARGET_ARCH_ARM32_V6)
            # ARMv6 (Raspberry Pi 1/Zero)
            set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv6 -mfpu=vfp -mfloat-abi=hard")
            message(STATUS "   - ARMv6 with VFP support")
        else()
            # é€šç”¨ ARM32
            set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -mfloat-abi=hard")
            message(STATUS "   - Generic ARM32 with hard float")
        endif()
        
        # é’ˆå¯¹ ARM32 çš„é¢å¤–ä¼˜åŒ–
        set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O2")  # ARM32 ç”¨ O2 æ›´ç¨³å®š
        message(STATUS "   - Using -O2 for better stability on ARM32")
    endif()
elseif(MSVC)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /W4")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /O2")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} /Od /Zi")
endif()

# è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# åŒ…å«ç›®å½•
include_directories(
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/src
)

# æŸ¥æ‰¾ä¾èµ–
# è®¾ç½® pthread é¦–é€‰é¡¹ï¼ˆé¿å… -lpthreads é”™è¯¯ï¼‰
set(THREADS_PREFER_PTHREAD_FLAG ON)
find_package(Threads REQUIRED)

# ä¿®å¤æŸäº›ç³»ç»Ÿä¸Š pthread åº“åé”™è¯¯çš„é—®é¢˜
if(CMAKE_THREAD_LIBS_INIT STREQUAL "-lpthreads")
    set(CMAKE_THREAD_LIBS_INIT "-lpthread")
    set(CMAKE_HAVE_THREADS_LIBRARY 1)
    set(Threads_FOUND TRUE)
    message(STATUS "Fixed pthread library name: -lpthreads -> -lpthread")
endif()

# æ‰“å° Threads ä¿¡æ¯ç”¨äºè°ƒè¯•
message(STATUS "Threads library: ${CMAKE_THREAD_LIBS_INIT}")

# æ£€æŸ¥ C++17 filesystem æ”¯æŒ
include(CheckCXXSourceCompiles)
set(CMAKE_REQUIRED_FLAGS "-std=c++17")
check_cxx_source_compiles("
    #include <filesystem>
    int main() { std::filesystem::path p; return 0; }
" HAVE_FILESYSTEM_WITHOUT_LIB)

if(NOT HAVE_FILESYSTEM_WITHOUT_LIB)
    set(NEED_FILESYSTEM_LIB TRUE)
    message(STATUS "C++17 filesystem requires explicit linking")
else()
    message(STATUS "C++17 filesystem available without explicit linking")
endif()

# æºæ–‡ä»¶
set(CORE_SOURCES
    src/core/engine.cpp
    src/core/system_detector.cpp
    src/core/config.cpp
    src/utils/logger.cpp
    src/utils/file_utils.cpp
    src/managers/component_manager.cpp
    src/managers/plugin_manager.cpp
)

# CLI æºæ–‡ä»¶
set(CLI_SOURCES
    src/cli/main.cpp
    src/cli/commands.cpp
    src/cli/cli_handler.cpp
)

# åˆ›å»ºæ ¸å¿ƒåº“
add_library(linuxstudio_core STATIC ${CORE_SOURCES})
target_link_libraries(linuxstudio_core 
    Threads::Threads
)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(xkl ${CLI_SOURCES})

# å¹³å°ç‰¹å®šçš„é“¾æ¥åº“
target_link_libraries(xkl 
    linuxstudio_core
    Threads::Threads
)

# å¦‚æœéœ€è¦æ˜¾å¼é“¾æ¥ filesystem åº“
if(NEED_FILESYSTEM_LIB AND PLATFORM_LINUX)
    target_link_libraries(xkl stdc++fs)
endif()

# ARM32 ç‰¹å®šé“¾æ¥åº“ï¼ˆæŸäº›æ—§ç‰ˆæœ¬éœ€è¦æ˜¾å¼é“¾æ¥ atomicï¼‰
if(TARGET_ARCH_ARM32)
    target_link_libraries(xkl atomic)
endif()

# å®‰è£…è§„åˆ™
install(TARGETS xkl
    RUNTIME DESTINATION bin
)

# åˆ›å»ºç¬¦å·é“¾æ¥ linuxstudio -> xklï¼ˆå‘åå…¼å®¹ï¼‰
install(CODE "
    set(SYMLINK_PATH \"\$ENV{DESTDIR}\${CMAKE_INSTALL_PREFIX}/bin/linuxstudio\")
    set(TARGET_PATH \"xkl\")
    if(NOT EXISTS \"\${SYMLINK_PATH}\")
        execute_process(
            COMMAND \${CMAKE_COMMAND} -E create_symlink \${TARGET_PATH} \${SYMLINK_PATH}
        )
    endif()
")

install(DIRECTORY ${CMAKE_SOURCE_DIR}/include/
    DESTINATION include/linuxstudio
)

# åˆ›å»ºè¿è¡Œæ—¶ç›®å½•ç»“æ„
install(DIRECTORY DESTINATION /opt/linuxstudio/plugins)
install(DIRECTORY DESTINATION /opt/linuxstudio/components)
install(DIRECTORY DESTINATION /opt/linuxstudio/data)
install(DIRECTORY DESTINATION /opt/linuxstudio/logs)
install(DIRECTORY DESTINATION /opt/linuxstudio/scenes)

# åˆ›å»ºé…ç½®ç›®å½•
install(DIRECTORY DESTINATION /etc/linuxstudio)

# å®‰è£…é»˜è®¤é…ç½®æ–‡ä»¶
install(CODE "
    set(CONFIG_FILE \"\$ENV{DESTDIR}/etc/linuxstudio/config.yaml\")
    if(NOT EXISTS \"\${CONFIG_FILE}\")
        file(WRITE \"\${CONFIG_FILE}\" \"# LinuxStudio Configuration
version: 1.0.0
install_path: /opt/linuxstudio
log_level: info
auto_update_check: true
\")
    endif()
")

# æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
enable_testing()
# add_subdirectory(tests)

# ========== CPack æ‰“åŒ…é…ç½® ==========
set(CPACK_PACKAGE_NAME "${PROJECT_NAME}")
set(CPACK_PACKAGE_VERSION "${PROJECT_VERSION}")
set(CPACK_PACKAGE_VENDOR "Dino Studio")
set(CPACK_PACKAGE_CONTACT "support@linuxstudio.org")
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "High-Performance Linux Environment Manager")
set(CPACK_PACKAGE_DESCRIPTION "LinuxStudio is a framework for managing development environments, toolchains, and multi-server deployments.")
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_SOURCE_DIR}/LICENSE")
set(CPACK_RESOURCE_FILE_README "${CMAKE_SOURCE_DIR}/README.md")

# CPack æ¶æ„è®¾ç½®ï¼ˆå¿…é¡»åœ¨ include(CPack) ä¹‹å‰ï¼‰
if(TARGET_ARCH_ARM64)
    set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "arm64")
    set(CPACK_RPM_PACKAGE_ARCHITECTURE "aarch64")
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "bash (>= 5.0)")
    set(CPACK_RPM_PACKAGE_REQUIRES "bash >= 5.0")
elseif(TARGET_ARCH_ARM32)
    set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "armhf")
    set(CPACK_RPM_PACKAGE_ARCHITECTURE "armv7hl")
    # ARM32 ç‰¹å®šçš„åŒ…ä¾èµ–
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "bash (>= 5.0), libatomic1")
    set(CPACK_RPM_PACKAGE_REQUIRES "bash >= 5.0, libatomic")
elseif(TARGET_ARCH_X86_64)
    set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "amd64")
    set(CPACK_RPM_PACKAGE_ARCHITECTURE "x86_64")
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "bash (>= 5.0)")
    set(CPACK_RPM_PACKAGE_REQUIRES "bash >= 5.0")
elseif(TARGET_ARCH_X86)
    set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "i386")
    set(CPACK_RPM_PACKAGE_ARCHITECTURE "i686")
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "bash (>= 5.0)")
    set(CPACK_RPM_PACKAGE_REQUIRES "bash >= 5.0")
else()
    # è‡ªåŠ¨æ£€æµ‹
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64")
        set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "arm64")
        set(CPACK_RPM_PACKAGE_ARCHITECTURE "aarch64")
    elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "armv[67]|arm")
        set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "armhf")
        set(CPACK_RPM_PACKAGE_ARCHITECTURE "armv7hl")
        set(CPACK_DEBIAN_PACKAGE_DEPENDS "bash (>= 5.0), libatomic1")
    elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64")
        set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "amd64")
        set(CPACK_RPM_PACKAGE_ARCHITECTURE "x86_64")
    endif()
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "bash (>= 5.0)")
    set(CPACK_RPM_PACKAGE_REQUIRES "bash >= 5.0")
endif()

# DEB åŒ…é…ç½®
set(CPACK_DEBIAN_PACKAGE_MAINTAINER "Dino Studio <support@linuxstudio.org>")
set(CPACK_DEBIAN_PACKAGE_SECTION "devel")
set(CPACK_DEBIAN_PACKAGE_PRIORITY "optional")
set(CPACK_DEBIAN_PACKAGE_HOMEPAGE "https://linuxstudio.org")

# RPM åŒ…é…ç½®
set(CPACK_RPM_PACKAGE_GROUP "Development/Tools")
set(CPACK_RPM_PACKAGE_LICENSE "MIT")
set(CPACK_RPM_PACKAGE_URL "https://linuxstudio.org")

# åŒ…å« CPackï¼ˆå¿…é¡»åœ¨æ‰€æœ‰ CPACK_* å˜é‡è®¾ç½®ä¹‹åï¼‰
include(CPack)

# æ‰“å°é…ç½®ä¿¡æ¯
message(STATUS "")
message(STATUS "========================================")
message(STATUS "LinuxStudio Build Configuration:")
message(STATUS "========================================")
message(STATUS "  Version: ${PROJECT_VERSION}")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "  Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  Compiler ID: ${CMAKE_CXX_COMPILER_ID}")
message(STATUS "  Compiler Version: ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "  Compiler Path: ${CMAKE_CXX_COMPILER}")
message(STATUS "  System: ${CMAKE_SYSTEM_NAME}")
message(STATUS "  System Processor: ${CMAKE_SYSTEM_PROCESSOR}")
if(TARGET_ARCH_ARM32)
    message(STATUS "  ARM32 Optimizations: Enabled")
    if(TARGET_ARCH_ARM32_V7)
        message(STATUS "    - ARMv7 with NEON")
    elseif(TARGET_ARCH_ARM32_V6)
        message(STATUS "    - ARMv6 with VFP")
    endif()
endif()
message(STATUS "  DEB Architecture: ${CPACK_DEBIAN_PACKAGE_ARCHITECTURE}")
message(STATUS "  RPM Architecture: ${CPACK_RPM_PACKAGE_ARCHITECTURE}")
message(STATUS "  Install Prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "========================================")
message(STATUS "")

