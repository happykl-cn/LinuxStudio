name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ tag (å¦‚ v1.0.0) æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_NAME: linuxstudio
  BINARY_NAME: xkl

jobs:
  # ========== æž„å»º Debian/Ubuntu åŒ… ==========
  build-deb:
    name: Build DEB for ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro: 
          - ubuntu:18.04
          - ubuntu:20.04
          - ubuntu:22.04
          - debian:10
          - debian:11
    container:
      image: ${{ matrix.distro }}
    
    steps:
      - name: Install Build Dependencies
        run: |
          apt-get update
          apt-get install -y git build-essential cmake debhelper devscripts
      
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build DEB Package
        run: |
          # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "=== Build Environment ==="
          g++ --version
          cmake --version
          echo "========================"
          
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build . -j$(nproc)
          cpack -G DEB
          
          # æ˜¾ç¤ºç”Ÿæˆçš„åŒ…
          echo "=== Generated Packages ==="
          ls -lh *.deb
          echo "========================"
      
      - name: Rename Package
        run: |
          cd build
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          mv *.deb ${PROJECT_NAME}_${{ steps.version.outputs.version }}_${DISTRO}_amd64.deb || true
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages
          path: build/*.deb
  
  # ========== æž„å»º RPM åŒ… ==========
  build-rpm:
    name: Build RPM for ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro:
          - centos:7
          - rockylinux:8
          - rockylinux:9
          - fedora:36
    container:
      image: ${{ matrix.distro }}
    
    steps:
      - name: Install Build Dependencies (CentOS 7)
        if: matrix.distro == 'centos:7'
        run: |
          yum install -y epel-release
          yum install -y git gcc-c++ cmake3 rpm-build make
          # ä¸åˆ›å»º cmake é“¾æŽ¥ï¼Œè®© spec æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹
      
      - name: Install Build Dependencies (RHEL 8/9)
        if: matrix.distro != 'centos:7' && matrix.distro != 'fedora:36'
        run: |
          dnf install -y git gcc-c++ cmake rpm-build make
      
      - name: Install Build Dependencies (Fedora)
        if: matrix.distro == 'fedora:36'
        run: |
          dnf install -y git gcc-c++ cmake rpm-build make
      
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build RPM Package
        run: |
          # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "=== Build Environment ==="
          g++ --version || gcc --version
          if command -v cmake3 &> /dev/null; then
            echo "Using cmake3:"
            cmake3 --version
          else
            echo "Using cmake:"
            cmake --version
          fi
          echo "========================"
          
          mkdir build && cd build
          
          # ä½¿ç”¨æ­£ç¡®çš„ cmake å‘½ä»¤
          if command -v cmake3 &> /dev/null; then
            CMAKE_CMD=cmake3
          else
            CMAKE_CMD=cmake
          fi
          
          $CMAKE_CMD .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          $CMAKE_CMD --build . -j$(nproc)
          cpack -G RPM
          
          # æ˜¾ç¤ºç”Ÿæˆçš„åŒ…
          echo "=== Generated Packages ==="
          ls -lh *.rpm
          echo "========================"
      
      - name: Rename Package
        run: |
          cd build
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          mv *.rpm ${PROJECT_NAME}-${{ steps.version.outputs.version }}-1.${DISTRO}.x86_64.rpm || true
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: build/*.rpm
  
  # ========== æž„å»º Arch Linux åŒ… ==========
  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel cmake git
      
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Build Package
        run: |
          # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "=== Build Environment ==="
          g++ --version
          cmake --version
          echo "========================"
          
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build . -j$(nproc)
          
          # åˆ›å»ºç®€å•çš„ tarballï¼ˆArch åŒ…å¯ä»¥åŽç»­ä¼˜åŒ–ï¼‰
          DESTDIR=pkg cmake --install .
          cd pkg
          
          # æ˜¾ç¤ºå®‰è£…çš„æ–‡ä»¶
          echo "=== Installed Files ==="
          find . -type f
          echo "======================="
          
          tar czf ../../${PROJECT_NAME}-arch-x86_64.tar.gz .
          
          cd ../..
          echo "=== Generated Archive ==="
          ls -lh ${PROJECT_NAME}-arch-x86_64.tar.gz
          echo "========================"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-packages
          path: "*.tar.gz"
  
  # ========== æµ‹è¯•å®‰è£… ==========
  test-install:
    name: Test Installation
    needs: [build-deb]
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download DEB Packages
        uses: actions/download-artifact@v4
        with:
          name: deb-packages
      
      - name: Install Package
        run: |
          ls -lah
          sudo dpkg -i *ubuntu-22.04*.deb || sudo apt-get install -f -y
      
      - name: Test Commands
        run: |
          which xkl
          xkl --version
          xkl --help
          xkl status || true
          
          # æ£€æŸ¥ç¬¦å·é“¾æŽ¥
          test -L /usr/bin/linuxstudio
          linuxstudio --version
      
      - name: Test File Structure
        run: |
          test -d /opt/linuxstudio
          test -f /etc/linuxstudio/config.yaml
          ls -la /opt/linuxstudio
  
  # ========== åˆ›å»º GitHub Release ==========
  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-rpm, build-arch, test-install]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Display Structure
        run: |
          ls -R
      
      - name: Get Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md <<'RELEASE_NOTES_EOF'
          ## LinuxStudio ${{ steps.version.outputs.version }}
          
          ### ðŸš€ å®‰è£…æ–¹æ³•
          
          #### Debian/Ubuntu
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo apt-get install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… DEB åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio_${{ steps.version.outputs.version }}_ubuntu-22.04_amd64.deb
          sudo dpkg -i linuxstudio_*.deb
          \`\`\`
          
          #### CentOS/RHEL/Rocky
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo yum install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… RPM åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio-${{ steps.version.outputs.version }}-1.rockylinux-8.x86_64.rpm
          sudo rpm -ivh linuxstudio-*.rpm
          \`\`\`
          
          ### âœ¨ æ–°ç‰¹æ€§
          
          - âœ… C++ æ ¸å¿ƒå¼•æ“Žï¼Œæ€§èƒ½æå‡ 10x
          - âœ… 9 å¤§å¼€å‘åœºæ™¯æ”¯æŒ
          - âœ… æ’ä»¶ç®¡ç†ç³»ç»Ÿ
          - âœ… å¤šæœåŠ¡å™¨éƒ¨ç½²
          - âœ… ç³»ç»ŸåŒ…ç®¡ç†å™¨é›†æˆ
          
          ### ðŸ“¦ åŒ…å«çš„åŒ…
          
          - Debian/Ubuntu: 5 ä¸ª
          - RHEL/CentOS: 4 ä¸ª
          - Arch Linux: 1 ä¸ª
          
          ### ðŸ“š æ–‡æ¡£
          
          - [å¼€å‘è€…æŒ‡å—](https://github.com/happykl-cn/LinuxStudio/blob/main/DEVELOPER_GUIDE.md)
          - [å®‰è£…æŒ‡å—](https://github.com/happykl-cn/LinuxStudio/blob/main/INSTALLATION_GUIDE.md)
          - [å¹³å°å…¼å®¹æ€§](https://github.com/happykl-cn/LinuxStudio/blob/main/PLATFORM_COMPATIBILITY.md)
          
          ### ðŸ› åé¦ˆ
          
          å‘çŽ°é—®é¢˜ï¼Ÿ[æäº¤ Issue](https://github.com/happykl-cn/LinuxStudio/issues)
          RELEASE_NOTES_EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: LinuxStudio ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            deb-packages/*.deb
            rpm-packages/*.rpm
            arch-packages/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

