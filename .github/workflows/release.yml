name: Build and Release v2

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ tag (å¦‚ v1.0.0) æ—¶è§¦å‘
    branches:
      - 'main'  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_rebuild:
        description: 'Force rebuild (ignore cache)'
        required: false
        default: 'false'

env:
  PROJECT_NAME: linuxstudio
  BINARY_NAME: xkl

jobs:
  # ========== æž„å»º Debian/Ubuntu åŒ… ==========
  build-deb:
    name: Build DEB for ${{ matrix.distro }}
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å¢žåŠ è¶…æ—¶æ—¶é—´
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–æž„å»ºç»§ç»­
      matrix:
        distro: 
          - ubuntu:20.04
          - ubuntu:22.04
          - ubuntu:24.04
          - debian:11
          - debian:12
    container:
      image: ${{ matrix.distro }}
    
    steps:
      - name: Fix Debian/Ubuntu Sources
        run: |
          # å¤‡ä»½åŽŸå§‹æº
          cp /etc/apt/sources.list /etc/apt/sources.list.bak || true
          
          # å¯¹äºŽ Debianï¼Œä½¿ç”¨å®˜æ–¹é•œåƒ
          if grep -q "Debian" /etc/os-release 2>/dev/null; then
            CODENAME=$(grep VERSION_CODENAME /etc/os-release | cut -d= -f2)
            cat > /etc/apt/sources.list <<EOF
          deb http://deb.debian.org/debian ${CODENAME} main contrib non-free
          deb http://deb.debian.org/debian ${CODENAME}-updates main contrib non-free
          deb http://security.debian.org/debian-security ${CODENAME}-security main contrib non-free
          EOF
            echo "=== Updated Debian sources to: ${CODENAME} ==="
          fi
          
      - name: Install Build Dependencies
        run: |
          # ä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿï¼ˆå¯é€‰ï¼‰
          export DEBIAN_FRONTEND=noninteractive
          
          apt-get update
          apt-get install -y --no-install-recommends \
            git \
            build-essential \
            cmake \
            debhelper \
            devscripts \
            lsb-release \
            ca-certificates
          
          # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
          echo "=== System Info ==="
          lsb_release -a || cat /etc/os-release
          g++ --version | head -1
          cmake --version | head -1
          echo "==================="
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build DEB Package
        run: |
          # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "=== Build Environment ==="
          g++ --version
          cmake --version
          echo "========================"
          
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build . -j$(nproc)
          cpack -G DEB
          
          # æ˜¾ç¤ºç”Ÿæˆçš„åŒ…
          echo "=== Generated Packages ==="
          ls -lh *.deb
          echo "========================"
      
      - name: Rename Package
        run: |
          cd build
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          mv *.deb ${PROJECT_NAME}_${{ steps.version.outputs.version }}_${DISTRO}_amd64.deb || true
          
          # è®¾ç½®å®‰å…¨çš„ artifact åç§°
          echo "ARTIFACT_NAME=deb-${DISTRO}-packages" >> $GITHUB_ENV
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: build/*.deb
  
  # ========== æž„å»º RPM åŒ… ==========
  build-rpm:
    name: Build RPM for ${{ matrix.distro }}
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å¢žåŠ è¶…æ—¶æ—¶é—´
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–æž„å»ºç»§ç»­
      matrix:
        distro:
          - rockylinux:8
          - rockylinux:9
          - fedora:38
          - fedora:39
    container:
      image: ${{ matrix.distro }}
    
    steps:
      - name: Install Build Dependencies
        run: |
          if command -v dnf &> /dev/null; then
            # Rocky/Fedora ä½¿ç”¨ dnf
            dnf install -y git gcc-c++ cmake rpm-build make
          elif command -v yum &> /dev/null; then
            # è€ç‰ˆæœ¬ä½¿ç”¨ yum
            yum install -y git gcc-c++ cmake rpm-build make
          fi
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build RPM Package
        run: |
          # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "=== Build Environment ==="
          g++ --version || gcc --version
          if command -v cmake3 &> /dev/null; then
            echo "Using cmake3:"
            cmake3 --version
          else
            echo "Using cmake:"
            cmake --version
          fi
          echo "========================"
          
          mkdir build && cd build
          
          # ä½¿ç”¨æ­£ç¡®çš„ cmake å‘½ä»¤
          if command -v cmake3 &> /dev/null; then
            CMAKE_CMD=cmake3
          else
            CMAKE_CMD=cmake
          fi
          
          $CMAKE_CMD .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          $CMAKE_CMD --build . -j$(nproc)
          cpack -G RPM
          
          # æ˜¾ç¤ºç”Ÿæˆçš„åŒ…
          echo "=== Generated Packages ==="
          ls -lh *.rpm
          echo "========================"
      
      - name: Rename Package
        run: |
          cd build
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          mv *.rpm ${PROJECT_NAME}-${{ steps.version.outputs.version }}-1.${DISTRO}.x86_64.rpm || true
          
          # è®¾ç½®å®‰å…¨çš„ artifact åç§°
          echo "ARTIFACT_NAME=rpm-${DISTRO}-packages" >> $GITHUB_ENV
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: build/*.rpm
  
  # ========== æž„å»º Arch Linux åŒ… ==========
  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å¢žåŠ è¶…æ—¶æ—¶é—´
    container:
      image: archlinux:latest
    
    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel cmake git
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Build Package
        run: |
          # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "=== Build Environment ==="
          g++ --version
          cmake --version
          echo "========================"
          
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build . -j$(nproc)
          
          # åˆ›å»ºç®€å•çš„ tarball
          DESTDIR=pkg cmake --install .
          
          # æ˜¾ç¤ºå®‰è£…çš„æ–‡ä»¶
          echo "=== Installed Files ==="
          find pkg -type f || true
          echo "======================="
          
          cd pkg
          tar czf ../../${PROJECT_NAME}-arch-x86_64.tar.gz .
          cd ../..
          
          echo "=== Generated Archive ==="
          ls -lh ${PROJECT_NAME}-arch-x86_64.tar.gz
          echo "========================"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-packages
          path: "*.tar.gz"
  
  # ========== æµ‹è¯•å®‰è£… ==========
  test-install:
    name: Test Installation
    needs: [build-deb]
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download DEB Packages
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*-packages
          merge-multiple: true
      
      - name: Install Package
        run: |
          ls -lah
          sudo dpkg -i *ubuntu-22.04*.deb || sudo apt-get install -f -y
      
      - name: Test Commands
        run: |
          which xkl
          xkl --version
          xkl --help
          xkl status || true
          
          # æ£€æŸ¥ç¬¦å·é“¾æŽ¥
          test -L /usr/bin/linuxstudio
          linuxstudio --version
      
      - name: Test File Structure
        run: |
          echo "=== Testing Directory Structure ==="
          
          # æ£€æŸ¥ä¸»ç›®å½•
          if [ -d /opt/linuxstudio ]; then
            echo "âœ… /opt/linuxstudio exists"
            ls -la /opt/linuxstudio
          else
            echo "âŒ /opt/linuxstudio does not exist"
            exit 1
          fi
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f /etc/linuxstudio/config.yaml ]; then
            echo "âœ… /etc/linuxstudio/config.yaml exists"
            cat /etc/linuxstudio/config.yaml
          else
            echo "âŒ /etc/linuxstudio/config.yaml does not exist"
            exit 1
          fi
          
          echo "=== All tests passed! ==="
  
  # ========== åˆ›å»º GitHub Release ==========
  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-rpm, build-arch, test-install]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-packages"
          merge-multiple: true
      
      - name: Display Structure
        run: |
          ls -R
      
      - name: Get Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md <<'RELEASE_NOTES_EOF'
          ## LinuxStudio ${{ steps.version.outputs.version }}
          
          ### ðŸš€ å®‰è£…æ–¹æ³•
          
          #### Debian/Ubuntu
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo apt-get install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… DEB åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio_${{ steps.version.outputs.version }}_ubuntu-22.04_amd64.deb
          sudo dpkg -i linuxstudio_*.deb
          \`\`\`
          
          #### CentOS/RHEL/Rocky
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo yum install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… RPM åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio-${{ steps.version.outputs.version }}-1.rockylinux-8.x86_64.rpm
          sudo rpm -ivh linuxstudio-*.rpm
          \`\`\`
          
          ### âœ¨ æ–°ç‰¹æ€§
          
          - âœ… C++ æ ¸å¿ƒå¼•æ“Žï¼Œæ€§èƒ½æå‡ 10x
          - âœ… 9 å¤§å¼€å‘åœºæ™¯æ”¯æŒ
          - âœ… æ’ä»¶ç®¡ç†ç³»ç»Ÿ
          - âœ… å¤šæœåŠ¡å™¨éƒ¨ç½²
          - âœ… ç³»ç»ŸåŒ…ç®¡ç†å™¨é›†æˆ
          
          ### ðŸ“¦ åŒ…å«çš„åŒ…
          
          - Debian/Ubuntu: 5 ä¸ª (20.04, 22.04, 24.04, Debian 11, 12)
          - RHEL/Rocky/Fedora: 4 ä¸ª (Rocky 8/9, Fedora 38/39)
          - Arch Linux: 1 ä¸ª
          
          ### ðŸ“š æ–‡æ¡£
          
          - [å¼€å‘è€…æŒ‡å—](https://github.com/happykl-cn/LinuxStudio/blob/main/DEVELOPER_GUIDE.md)
          - [å®‰è£…æŒ‡å—](https://github.com/happykl-cn/LinuxStudio/blob/main/INSTALLATION_GUIDE.md)
          - [å¹³å°å…¼å®¹æ€§](https://github.com/happykl-cn/LinuxStudio/blob/main/PLATFORM_COMPATIBILITY.md)
          
          ### ðŸ› åé¦ˆ
          
          å‘çŽ°é—®é¢˜ï¼Ÿ[æäº¤ Issue](https://github.com/happykl-cn/LinuxStudio/issues)
          RELEASE_NOTES_EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: LinuxStudio ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            **/*.deb
            **/*.rpm
            **/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

