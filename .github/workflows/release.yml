name: Build and Release v2

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ tag (å¦‚ v1.0.0) æ—¶è§¦å‘
    branches:
      - 'main'  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_rebuild:
        description: 'Force rebuild (ignore cache)'
        required: false
        default: 'false'

# è®¾ç½®æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º release
  packages: write  # å…è®¸ä¸Šä¼  artifacts

env:
  PROJECT_NAME: linuxstudio
  BINARY_NAME: xkl

jobs:
  # ========== æž„å»º Debian/Ubuntu åŒ… ==========
  build-deb:
    name: Build DEB for ${{ matrix.distro }} (${{ matrix.arch }})
    runs-on: ubuntu-latest
    timeout-minutes: 45  # å¢žåŠ è¶…æ—¶æ—¶é—´ (ARM æž„å»ºå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´)
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–æž„å»ºç»§ç»­
      matrix:
        include:
          # x86_64 (amd64) æž„å»º
          - distro: ubuntu:20.04
            arch: amd64
            platform: linux/amd64
          - distro: ubuntu:22.04
            arch: amd64
            platform: linux/amd64
          - distro: ubuntu:24.04
            arch: amd64
            platform: linux/amd64
          - distro: debian:11
            arch: amd64
            platform: linux/amd64
          - distro: debian:12
            arch: amd64
            platform: linux/amd64
          # ARM64 (aarch64) æž„å»º - ä¸ä½¿ç”¨ containerï¼Œæ”¹ç”¨ docker run
          - distro: ubuntu:22.04
            arch: arm64
            platform: linux/arm64/v8
          - distro: ubuntu:24.04
            arch: arm64
            platform: linux/arm64/v8
          - distro: debian:12
            arch: arm64
            platform: linux/arm64/v8
          # ARM32 (armhf/armv7) æž„å»º
          - distro: ubuntu:20.04
            arch: armhf
            platform: linux/arm/v7
          - distro: ubuntu:22.04
            arch: armhf
            platform: linux/arm/v7
          - distro: debian:11
            arch: armhf
            platform: linux/arm/v7
          - distro: debian:12
            arch: armhf
            platform: linux/arm/v7
    # ä¸ä½¿ç”¨ containerï¼Œæ‰€æœ‰æž„å»ºéƒ½åœ¨ä¸»æœºä¸Šä½¿ç”¨ docker run
    # è¿™æ ·å¯ä»¥é¿å… QEMU è®¾ç½®çš„æ—¶åºé—®é¢˜
    
    steps:
      - name: Setup QEMU (ARM only)
        if: matrix.arch == 'arm64' || matrix.arch == 'armhf'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch == 'arm64' && 'arm64' || 'arm' }}
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build DEB Package (x86_64)
        if: matrix.arch == 'amd64'
        run: |
          # åœ¨å®¹å™¨å†…ä¸€æ¬¡æ€§å®Œæˆå®‰è£…å’Œæž„å»º
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e VERSION="${{ steps.version.outputs.version }}" \
            -e DISTRO="${DISTRO}" \
            ${{ matrix.distro }} \
            bash -c "
            # å¤‡ä»½åŽŸå§‹æº
            cp /etc/apt/sources.list /etc/apt/sources.list.bak || true && \
            # å¯¹äºŽ Debianï¼Œä½¿ç”¨å®˜æ–¹é•œåƒ
            if grep -q 'Debian' /etc/os-release 2>/dev/null; then
              CODENAME=\$(grep VERSION_CODENAME /etc/os-release | cut -d= -f2)
              cat > /etc/apt/sources.list <<EOF
          deb http://deb.debian.org/debian \${CODENAME} main contrib non-free
          deb http://deb.debian.org/debian \${CODENAME}-updates main contrib non-free
          deb http://security.debian.org/debian-security \${CODENAME}-security main contrib non-free
          EOF
              echo '=== Updated Debian sources to: '\${CODENAME}' ==='
            fi && \
            # å®‰è£…ä¾èµ–
            export DEBIAN_FRONTEND=noninteractive && \
            apt-get update && \
            apt-get install -y --no-install-recommends \
              git build-essential g++ gcc cmake debhelper devscripts lsb-release ca-certificates && \
            echo '=== Build Environment ===' && \
            uname -m && \
            g++ --version | head -1 && \
            cmake --version | head -1 && \
            echo 'Target Architecture: ${{ matrix.arch }}' && \
            echo '========================' && \
            rm -rf build && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DCMAKE_INSTALL_PREFIX=/usr \
                     -DCMAKE_C_COMPILER=/usr/bin/gcc \
                     -DCMAKE_CXX_COMPILER=/usr/bin/g++ && \
            cmake --build . -j\$(nproc) && \
            export CPACK_DEBIAN_PACKAGE_ARCHITECTURE='amd64' && \
            cpack -G DEB && \
            echo '=== Generated Packages ===' && \
            ls -lh *.deb && \
            dpkg-deb -I *.deb | grep Architecture || true && \
            mv *.deb linuxstudio_\${VERSION}_\${DISTRO}_amd64.deb 2>/dev/null || true && \
            ls -lh *.deb && \
            echo '========================'
          "
      
      - name: Build DEB Package (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          # åœ¨ ARM å®¹å™¨ä¸­ä¸€æ¬¡æ€§å®Œæˆå®‰è£…å’Œæž„å»º
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          docker run --rm --platform=linux/arm64/v8 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e VERSION="${{ steps.version.outputs.version }}" \
            -e DISTRO="${DISTRO}" \
            ${{ matrix.distro }} \
            bash -c "
            # å¤‡ä»½åŽŸå§‹æº
            cp /etc/apt/sources.list /etc/apt/sources.list.bak || true && \
            # å¯¹äºŽ Debianï¼Œä½¿ç”¨å®˜æ–¹é•œåƒ
            if grep -q 'Debian' /etc/os-release 2>/dev/null; then
              CODENAME=\$(grep VERSION_CODENAME /etc/os-release | cut -d= -f2)
              cat > /etc/apt/sources.list <<EOF
          deb http://deb.debian.org/debian \${CODENAME} main contrib non-free
          deb http://deb.debian.org/debian \${CODENAME}-updates main contrib non-free
          deb http://security.debian.org/debian-security \${CODENAME}-security main contrib non-free
          EOF
              echo '=== Updated Debian sources to: '\${CODENAME}' ==='
            fi && \
            # å®‰è£…ä¾èµ–
            export DEBIAN_FRONTEND=noninteractive && \
            apt-get update && \
            apt-get install -y --no-install-recommends \
              git build-essential g++ gcc cmake debhelper devscripts lsb-release ca-certificates && \
            echo '=== Build Environment (ARM64) ===' && \
            uname -m && \
            g++ --version | head -1 && \
            cmake --version | head -1 && \
            echo 'Target Architecture: ${{ matrix.arch }}' && \
            echo '========================' && \
            rm -rf build && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DCMAKE_INSTALL_PREFIX=/usr \
                     -DCMAKE_C_COMPILER=/usr/bin/gcc \
                     -DCMAKE_CXX_COMPILER=/usr/bin/g++ && \
            cmake --build . -j\$(nproc) && \
            export CPACK_DEBIAN_PACKAGE_ARCHITECTURE='arm64' && \
            cpack -G DEB && \
            echo '=== Generated Packages ===' && \
            ls -lh *.deb && \
            dpkg-deb -I *.deb | grep Architecture || true && \
            mv *.deb linuxstudio_\${VERSION}_\${DISTRO}_arm64.deb 2>/dev/null || true && \
            ls -lh *.deb && \
            echo '========================'
          "
      
      - name: Build DEB Package (ARM32)
        if: matrix.arch == 'armhf'
        run: |
          # åœ¨ ARM32 å®¹å™¨ä¸­ä¸€æ¬¡æ€§å®Œæˆå®‰è£…å’Œæž„å»º
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          docker run --rm --platform=linux/arm/v7 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e VERSION="${{ steps.version.outputs.version }}" \
            -e DISTRO="${DISTRO}" \
            ${{ matrix.distro }} \
            bash -c "
            # å¤‡ä»½åŽŸå§‹æº
            cp /etc/apt/sources.list /etc/apt/sources.list.bak || true && \
            # å¯¹äºŽ Debianï¼Œä½¿ç”¨å®˜æ–¹é•œåƒ
            if grep -q 'Debian' /etc/os-release 2>/dev/null; then
              CODENAME=\$(grep VERSION_CODENAME /etc/os-release | cut -d= -f2)
              cat > /etc/apt/sources.list <<EOF
          deb http://deb.debian.org/debian \${CODENAME} main contrib non-free
          deb http://deb.debian.org/debian \${CODENAME}-updates main contrib non-free
          deb http://security.debian.org/debian-security \${CODENAME}-security main contrib non-free
          EOF
              echo '=== Updated Debian sources to: '\${CODENAME}' ==='
            fi && \
            # å®‰è£…ä¾èµ–ï¼ˆARM32 éœ€è¦ libatomic1ï¼‰
            export DEBIAN_FRONTEND=noninteractive && \
            apt-get update && \
            apt-get install -y --no-install-recommends \
              git build-essential g++ gcc cmake debhelper devscripts lsb-release ca-certificates libatomic1 && \
            echo '=== Build Environment (ARM32) ===' && \
            echo 'Architecture:' && uname -m && \
            echo 'GCC Version:' && gcc --version | head -1 && \
            echo 'G++ Version:' && g++ --version | head -1 && \
            echo 'CMake Version:' && cmake --version | head -1 && \
            echo 'Target Architecture: ${{ matrix.arch }} (armhf)' && \
            echo 'CPU Info:' && \
            cat /proc/cpuinfo | grep -i 'model\|hardware\|revision\|features' | head -10 || true && \
            echo '========================' && \
            echo 'Creating ARM32 toolchain file...' && \
            mkdir -p cmake && \
            echo 'set(CMAKE_SYSTEM_NAME Linux)' > cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_SYSTEM_PROCESSOR armv7l)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_C_COMPILER /usr/bin/gcc)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_COMPILER /usr/bin/g++)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_C_COMPILER_FORCED TRUE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_COMPILER_FORCED TRUE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_C_COMPILER_WORKS TRUE CACHE BOOL \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_COMPILER_WORKS TRUE CACHE BOOL \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_C_COMPILER_ID GNU CACHE STRING \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_COMPILER_ID GNU CACHE STRING \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_C_COMPILER_ID_RUN TRUE CACHE BOOL \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_COMPILER_ID_RUN TRUE CACHE BOOL \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_COMPILER_IS_GNUCXX 1)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_COMPILER_IS_GNUCC 1)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_STANDARD 17)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_STANDARD_REQUIRED ON)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_CXX_EXTENSIONS OFF)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_EXE_LINKER_FLAGS \"-pthread\" CACHE STRING \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'set(CMAKE_SHARED_LINKER_FLAGS \"-pthread\" CACHE STRING \"\" FORCE)' >> cmake/arm32-toolchain.cmake && \
            echo 'Toolchain file contents:' && \
            cat cmake/arm32-toolchain.cmake && \
            echo 'Configuring CMake with toolchain file...' && \
            rm -rf build CMakeCache.txt CMakeFiles && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_TOOLCHAIN_FILE=../cmake/arm32-toolchain.cmake \
                     -DCMAKE_BUILD_TYPE=Release \
                     -DCMAKE_INSTALL_PREFIX=/usr \
                     -DCMAKE_VERBOSE_MAKEFILE=ON || { \
              echo '=== CMake Configuration Failed ===' && \
              echo 'CMakeOutput.log:' && \
              cat CMakeFiles/CMakeOutput.log | tail -50 && \
              echo 'CMakeError.log:' && \
              cat CMakeFiles/CMakeError.log | tail -50 && \
              exit 1; \
            } && \
            echo 'Building project...' && \
            cmake --build . -j\$(nproc) && \
            export CPACK_DEBIAN_PACKAGE_ARCHITECTURE='armhf' && \
            cpack -G DEB && \
            echo '=== Generated Packages ===' && \
            ls -lh *.deb && \
            dpkg-deb -I *.deb | grep Architecture || true && \
            mv *.deb linuxstudio_\${VERSION}_\${DISTRO}_armhf.deb 2>/dev/null || true && \
            ls -lh *.deb && \
            echo '========================'
          "
      
      - name: Set Artifact Name
        run: |
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          ARCH="${{ matrix.arch }}"
          echo "ARTIFACT_NAME=deb-${DISTRO}-${ARCH}-packages" >> $GITHUB_ENV
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: build/*.deb
  
  # ========== æž„å»º RPM åŒ… ==========
  build-rpm:
    name: Build RPM for ${{ matrix.distro }} (${{ matrix.arch }})
    runs-on: ubuntu-latest
    timeout-minutes: 45  # å¢žåŠ è¶…æ—¶æ—¶é—´ (ARM æž„å»ºå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´)
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–æž„å»ºç»§ç»­
      matrix:
        include:
          # x86_64 æž„å»º
          - distro: rockylinux:8
            arch: x86_64
            platform: linux/amd64
          - distro: rockylinux:9
            arch: x86_64
            platform: linux/amd64
          - distro: fedora:38
            arch: x86_64
            platform: linux/amd64
          - distro: fedora:39
            arch: x86_64
            platform: linux/amd64
          # ARM64 (aarch64) æž„å»º
          - distro: rockylinux:9
            arch: aarch64
            platform: linux/arm64/v8
          - distro: fedora:39
            arch: aarch64
            platform: linux/arm64/v8
          # ARM32 (armhfp/armv7hl) æž„å»º - Fedora ä¸æ”¯æŒ ARM32ï¼Œè·³è¿‡
    # ä¸ä½¿ç”¨ containerï¼Œæ‰€æœ‰æž„å»ºéƒ½åœ¨ä¸»æœºä¸Šä½¿ç”¨ docker run
    
    steps:
      - name: Setup QEMU (ARM only)
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build RPM Package (x86_64)
        if: matrix.arch == 'x86_64'
        run: |
          # åœ¨å®¹å™¨å†…ä¸€æ¬¡æ€§å®Œæˆå®‰è£…å’Œæž„å»º
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e VERSION="${{ steps.version.outputs.version }}" \
            -e DISTRO="${DISTRO}" \
            ${{ matrix.distro }} \
            bash -c "
            # å®‰è£…ä¾èµ–
            if command -v dnf &> /dev/null; then
              dnf install -y git gcc-c++ cmake rpm-build make
            elif command -v yum &> /dev/null; then
              yum install -y git gcc-c++ cmake rpm-build make
            fi && \
            echo '=== Build Environment ===' && \
            uname -m && \
            g++ --version || gcc --version && \
            if command -v cmake3 &> /dev/null; then
              echo 'Using cmake3:' && \
              cmake3 --version && \
              CMAKE_CMD=cmake3
            else
              echo 'Using cmake:' && \
              cmake --version && \
              CMAKE_CMD=cmake
            fi && \
            echo 'Target Architecture: ${{ matrix.arch }}' && \
            echo '========================' && \
            mkdir -p build && cd build && \
            \$CMAKE_CMD .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr && \
            \$CMAKE_CMD --build . -j\$(nproc) && \
            export CPACK_RPM_PACKAGE_ARCHITECTURE='x86_64' && \
            cpack -G RPM && \
            echo '=== Generated Packages ===' && \
            ls -lh *.rpm && \
            rpm -qp --queryformat '%{ARCH}\n' *.rpm | head -1 || true && \
            mv *.rpm linuxstudio-\${VERSION}-1.\${DISTRO}.x86_64.rpm 2>/dev/null || true && \
            ls -lh *.rpm && \
            echo '========================'
          "
      
      - name: Build RPM Package (ARM64)
        if: matrix.arch == 'aarch64'
        run: |
          # åœ¨ ARM å®¹å™¨å†…ä¸€æ¬¡æ€§å®Œæˆå®‰è£…å’Œæž„å»º
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          docker run --rm --platform=linux/arm64/v8 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e VERSION="${{ steps.version.outputs.version }}" \
            -e DISTRO="${DISTRO}" \
            ${{ matrix.distro }} \
            bash -c "
            # å®‰è£…ä¾èµ–
            if command -v dnf &> /dev/null; then
              dnf install -y git gcc-c++ cmake rpm-build make
            elif command -v yum &> /dev/null; then
              yum install -y git gcc-c++ cmake rpm-build make
            fi && \
            echo '=== Build Environment ===' && \
            uname -m && \
            g++ --version || gcc --version && \
            if command -v cmake3 &> /dev/null; then
              echo 'Using cmake3:' && \
              cmake3 --version && \
              CMAKE_CMD=cmake3
            else
              echo 'Using cmake:' && \
              cmake --version && \
              CMAKE_CMD=cmake
            fi && \
            echo 'Target Architecture: ${{ matrix.arch }}' && \
            echo '========================' && \
            mkdir -p build && cd build && \
            \$CMAKE_CMD .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr && \
            \$CMAKE_CMD --build . -j\$(nproc) && \
            export CPACK_RPM_PACKAGE_ARCHITECTURE='aarch64' && \
            cpack -G RPM && \
            echo '=== Generated Packages ===' && \
            ls -lh *.rpm && \
            rpm -qp --queryformat '%{ARCH}\n' *.rpm | head -1 || true && \
            mv *.rpm linuxstudio-\${VERSION}-1.\${DISTRO}.aarch64.rpm 2>/dev/null || true && \
            ls -lh *.rpm && \
            echo '========================'
          "
      
      - name: Set Artifact Name
        run: |
          DISTRO=$(echo "${{ matrix.distro }}" | tr ':' '-')
          ARCH="${{ matrix.arch }}"
          echo "ARTIFACT_NAME=rpm-${DISTRO}-${ARCH}-packages" >> $GITHUB_ENV
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: build/*.rpm
  
  # ========== æž„å»º Arch Linux åŒ… ==========
  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å¢žåŠ è¶…æ—¶æ—¶é—´
    # ä¸ä½¿ç”¨ containerï¼Œæ”¹ç”¨ docker run
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Build Package
        run: |
          # åœ¨å®¹å™¨å†…ä¸€æ¬¡æ€§å®Œæˆå®‰è£…å’Œæž„å»º
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            archlinux:latest \
            bash -c "
            # å®‰è£…ä¾èµ–
            pacman -Syu --noconfirm && \
            pacman -S --noconfirm base-devel cmake git && \
            echo '=== Build Environment ===' && \
            g++ --version && \
            cmake --version && \
            echo '========================' && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr && \
            cmake --build . -j\$(nproc) && \
            DESTDIR=pkg cmake --install . && \
            echo '=== Installed Files ===' && \
            find pkg -type f || true && \
            echo '=======================' && \
            cd pkg && \
            tar czf /workspace/${PROJECT_NAME}-arch-x86_64.tar.gz . && \
            cd /workspace && \
            echo '=== Generated Archive ===' && \
            ls -lh ${PROJECT_NAME}-arch-x86_64.tar.gz && \
            echo '========================'
          "
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-packages
          path: "*.tar.gz"
  
  # ========== æµ‹è¯•å®‰è£… ==========
  test-install:
    name: Test Installation
    needs: [build-deb]
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download DEB Packages
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*-packages
          merge-multiple: true
      
      - name: Install Package
        run: |
          ls -lah
          sudo dpkg -i *ubuntu-22.04*.deb || sudo apt-get install -f -y
      
      - name: Test Commands
        run: |
          which xkl
          xkl --version
          xkl --help
          xkl status || true
          
          # æ£€æŸ¥ç¬¦å·é“¾æŽ¥
          test -L /usr/bin/linuxstudio
          linuxstudio --version
      
      - name: Test File Structure
        run: |
          echo "=== Testing Directory Structure ==="
          
          # æ£€æŸ¥ä¸»ç›®å½•
          if [ -d /opt/linuxstudio ]; then
            echo "âœ… /opt/linuxstudio exists"
            ls -la /opt/linuxstudio
          else
            echo "âŒ /opt/linuxstudio does not exist"
            exit 1
          fi
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f /etc/linuxstudio/config.yaml ]; then
            echo "âœ… /etc/linuxstudio/config.yaml exists"
            cat /etc/linuxstudio/config.yaml
          else
            echo "âŒ /etc/linuxstudio/config.yaml does not exist"
            exit 1
          fi
          
          echo "=== All tests passed! ==="
  
  # ========== åˆ›å»º GitHub Release ==========
  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-rpm, build-arch, test-install]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true  # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-packages"
          merge-multiple: true
      
      - name: Display Structure
        run: |
          ls -R
      
      - name: Get Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md <<'RELEASE_NOTES_EOF'
          ## LinuxStudio ${{ steps.version.outputs.version }}
          
          ### ðŸš€ å®‰è£…æ–¹æ³•
          
          #### Debian/Ubuntu (x86_64/amd64)
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo apt-get install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… DEB åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio_${{ steps.version.outputs.version }}_ubuntu-22.04_amd64.deb
          sudo dpkg -i linuxstudio_*.deb
          \`\`\`
          
          #### Debian/Ubuntu (ARM64/aarch64)
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo apt-get install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… DEB åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio_${{ steps.version.outputs.version }}_ubuntu-22.04_arm64.deb
          sudo dpkg -i linuxstudio_*.deb
          \`\`\`
          
          #### CentOS/RHEL/Rocky (x86_64)
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo yum install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… RPM åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio-${{ steps.version.outputs.version }}-1.rockylinux-8.x86_64.rpm
          sudo rpm -ivh linuxstudio-*.rpm
          \`\`\`
          
          #### CentOS/RHEL/Rocky (ARM64/aarch64)
          \`\`\`bash
          # é…ç½®ä»“åº“ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://packages.linuxstudio.org/setup.sh | sudo bash
          sudo yum install linuxstudio
          
          # æˆ–ç›´æŽ¥å®‰è£… RPM åŒ…
          wget https://github.com/happykl-cn/LinuxStudio/releases/download/${{ github.ref_name }}/linuxstudio-${{ steps.version.outputs.version }}-1.rockylinux-9.aarch64.rpm
          sudo rpm -ivh linuxstudio-*.rpm
          \`\`\`
          
          ### âœ¨ æ–°ç‰¹æ€§
          
          - âœ… C++ æ ¸å¿ƒå¼•æ“Žï¼Œæ€§èƒ½æå‡ 10x
          - âœ… 9 å¤§å¼€å‘åœºæ™¯æ”¯æŒ
          - âœ… æ’ä»¶ç®¡ç†ç³»ç»Ÿ
          - âœ… å¤šæœåŠ¡å™¨éƒ¨ç½²
          - âœ… ç³»ç»ŸåŒ…ç®¡ç†å™¨é›†æˆ
          
          ### ðŸ“¦ åŒ…å«çš„åŒ…
          
          - Debian/Ubuntu (amd64): 5 ä¸ª (20.04, 22.04, 24.04, Debian 11, 12)
          - Debian/Ubuntu (arm64): 3 ä¸ª (Ubuntu 22.04/24.04, Debian 12)
          - Debian/Ubuntu (armhf): 4 ä¸ª (Ubuntu 20.04/22.04, Debian 11/12) â­ æ–°å¢ž
          - RHEL/Rocky/Fedora (x86_64): 4 ä¸ª (Rocky 8/9, Fedora 38/39)
          - RHEL/Rocky/Fedora (aarch64): 2 ä¸ª (Rocky 9, Fedora 39)
          - Arch Linux: 1 ä¸ª
          
          **æ³¨æ„**: RPM ç³»å‘è¡Œç‰ˆå®˜æ–¹ä¸å†æ”¯æŒ ARM32 æž¶æž„ï¼Œè¯·ä½¿ç”¨ Debian/Ubuntu ç³»ç»Ÿ
          
          ### ðŸ—ï¸ ARM æž¶æž„æ”¯æŒ
          
          - âœ… **ARM64 (aarch64)** å®Œæ•´æ”¯æŒ
            - Debian/Ubuntu/Fedora/Rocky Linux
            - Raspberry Pi 4/5, ARM æœåŠ¡å™¨
          - âœ… **ARM32 (armhf/armv7)** å®Œæ•´æ”¯æŒ
            - Debian/Ubuntu ç³»ç»Ÿ
            - Raspberry Pi å…¨ç³»åˆ— (Pi 1/2/3/4, Zero/Zero 2)
            - å„ç±» ARM32 å¼€å‘æ¿å’ŒåµŒå…¥å¼è®¾å¤‡
          - âœ… **æ€§èƒ½ä¼˜åŒ–**
            - ARMv7: NEON SIMD æŒ‡ä»¤é›†åŠ é€Ÿ
            - ARMv6: VFP æµ®ç‚¹è¿ç®—åŠ é€Ÿ
            - Hard Float ABI
          - âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½åœ¨ ARM å¹³å°ä¸Šå¯ç”¨
          
          ### ðŸ“š æ–‡æ¡£
          
          - [å¼€å‘è€…æŒ‡å—](https://github.com/happykl-cn/LinuxStudio/blob/main/DEVELOPER_GUIDE.md)
          - [å®‰è£…æŒ‡å—](https://github.com/happykl-cn/LinuxStudio/blob/main/INSTALLATION_GUIDE.md)
          - [å¹³å°å…¼å®¹æ€§](https://github.com/happykl-cn/LinuxStudio/blob/main/PLATFORM_COMPATIBILITY.md)
          
          ### ðŸ› åé¦ˆ
          
          å‘çŽ°é—®é¢˜ï¼Ÿ[æäº¤ Issue](https://github.com/happykl-cn/LinuxStudio/issues)
          RELEASE_NOTES_EOF
      
      - name: Debug Release Info
        run: |
          echo "=== Release Debug Info ==="
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Type: ${{ github.ref_type }}"
          echo "Tag Name: ${{ github.ref_name }}"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "=========================="
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "=== Files to Upload ==="
          find . -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" | head -20
          echo "=========================="
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: LinuxStudio ${{ steps.version.outputs.version }}
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: |
            **/*.deb
            **/*.rpm
            **/*.tar.gz
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

